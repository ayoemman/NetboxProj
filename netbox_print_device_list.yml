---
- name: Lookup NetBox Device Data Based on Role
  hosts: localhost
  gather_facts: no
  vars:
    netbox_url: "{{ lookup('env', 'NETBOX_URL') }}"
    netbox_token: "{{ lookup('env', 'NETBOX_TOKEN') }}"
    github_repo: "https://github.com/ayoemman/NetboxProj.git"
    github_token: "{{ lookup('env', 'GIT_TOKEN') }}"
    repo_branch: "main"
    config_file_path: "/tmp/config_file.txt"
    repo_dest: "/tmp/repo"
    git_user_name: "ayoemman"
    git_user_email: "ayoemman006@gmail.com"

  tasks:
    - name: Get device configurations from NetBox
      uri:
        url: "{{ netbox_url }}dcim/devices/"
        method: GET
        headers:
          Authorization: "Token {{ netbox_token }}"
        return_content: yes
      register: netbox_response

    - name: Write configuration to local file
      copy:
        content: "{{ netbox_response.content }}"
        dest: "{{ config_file_path }}"

    - name: Clone GitHub repository
      git:
        repo: "{{ github_repo }}"
        dest: "{{ repo_dest }}"
        version: "{{ repo_branch }}"
        force: yes
      register: git_result

    - name: Copy configuration file to repository
      copy:
        src: "{{ config_file_path }}"
        dest: "{{ repo_dest }}/config_file.txt"
    
    - name: Set Git user name
      command: git config --global user.name "{{ git_user_name }}"
      args:
        chdir: "{{ repo_dest }}"

    - name: Set Git user email
      command: git config --global user.email "{{ git_user_email }}"
      args:
        chdir: "{{ repo_dest }}"

    - name: Commit changes to repository
      command: git commit -am "Add configuration file"
      args:
        chdir: "{{ repo_dest }}"

    - name: Push changes to GitHub
      command: git push -v origin "{{ repo_branch }}"
      args:
        chdir: "{{ repo_dest }}"
      environment:
        GIT_TOKEN: "{{ github_token }}"
