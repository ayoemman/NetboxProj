---
- name: Fetch devices from NetBox and save to local HTML file
  hosts: localhost
  gather_facts: no

  vars:
    netbox_url: "https://mnqh6527.cloud.netboxapp.com"
    netbox_token: "7e1c591e544353bedaeba2fdca5309ff16dfe268"
    output_file: "/home/user1/netbox_report/devices.html"

  tasks:
    - name: Print the current user
      command: whoami
      register: whoami_output

    - name: Print the current user output
      debug:
        var: whoami_output.stdout

    - name: Print the current working directory
      command: pwd
      register: pwd_output

    - name: Print the current working directory output
      debug:
        var: pwd_output.stdout

    - name: Ensure the /home/netbox_report/report directory exists
      file:
        path: /home/user1/netbox_report
        state: directory
        mode: '0755'

    - name: Fetch devices from NetBox
      uri:
        url: "{{ netbox_url }}/api/dcim/devices/"
        method: GET
        headers:
          Authorization: "Token {{ netbox_token }}"
        return_content: yes
      register: netbox_response

    - name: Debug NetBox devices response
      debug:
        var: netbox_response.json.results

    - name: Save NetBox devices to a JSON file
      copy:
        content: "{{ netbox_response.content }}"
        dest: "/tmp/netbox_devices.json"

    - name: Debug the devices variable before template
      debug:
        var: netbox_response.json.results

    - name: Convert NetBox devices JSON to HTML
      template:
        src: templates/netbox_devices.html.j2
        dest: "{{ output_file }}"
      vars:
        devices: "{{ netbox_response.json.results }}"
        register: template_result

    - name: Debug the result of converting JSON to HTML
      debug:
        var: template_result

    - name: Check if HTML file exists
      stat:
        path: "{{ output_file }}"
      register: html_file_stat

    - name: Debug the result of HTML file existence check
      debug:
        var: html_file_stat
